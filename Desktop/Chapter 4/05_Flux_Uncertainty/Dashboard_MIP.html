<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIP Sewage Input - DDM30 Basins</title>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Data -->
    <script src="mip_data_ddm30.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            background: #f0f2f5;
        }

        .sidebar {
            width: 350px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar h1 {
            font-size: 1.4em;
            margin-bottom: 5px;
            text-align: center;
        }

        .sidebar .subtitle {
            font-size: 0.85em;
            color: #e0e0e0;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stats-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stats-panel h3 {
            font-size: 1em;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .metric-val {
            font-weight: bold;
            color: #f1c40f;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 250px;
        }

        .legend {
            line-height: 18px;
            color: #555;
            background: white;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h1>MIP Sewage Input</h1>
        <div class="subtitle">DDM30 Basins - Scenario 10, s1</div>

        <div class="stats-panel">
            <h3>Global Statistics</h3>
            <div class="metric-row">
                <span>Total Basins:</span>
                <span class="metric-val" id="totalBasins">-</span>
            </div>
            <div class="metric-row">
                <span>Total MIP Input:</span>
                <span class="metric-val" id="totalMIP">-</span>
            </div>
            <div style="font-size:0.8em; margin-top:10px; color:#e0e0e0;">
                * MIP = Model Intercomparison Project sewage input
            </div>
        </div>

        <div class="stats-panel">
            <h3>About MIP Data</h3>
            <div style="font-size:0.85em; line-height:1.4;">
                <p style="margin-bottom:10px;">MIP sewage input includes:</p>
                <ul style="margin-left:20px;">
                    <li>Transport</li>
                    <li>Precipitation</li>
                    <li>Deposition</li>
                    <li>Land Dry</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div id="map"></div>
        <div class="map-controls">
            <h4 style="margin-bottom:10px; color:#2c3e50;">Map Legend</h4>
            <div id="legendContent"></div>
            <div style="margin-top:15px; font-size:0.85em; color:#95a5a6;">
                Total Basins: <span id="mapCount">0</span>
            </div>
        </div>
    </div>

    <script>
        let map = null;
        let mapLayer = null;

        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            }).addTo(map);

            L.control.scale().addTo(map);
        }

        function updateMap() {
            if (!map || !window.MIP_DATA_DDM30) return;
            if (mapLayer) map.removeLayer(mapLayer);

            const basins = window.MIP_DATA_DDM30.basins;
            document.getElementById('mapCount').textContent = basins.length;

            // Get min/max for color scale
            const vals = basins.map(b => b.mip_total).filter(v => v > 0);
            const minVal = Math.min(...vals);
            const maxVal = Math.max(...vals);

            function getColor(v) {
                if (v <= 0) return '#ccc';
                const logMin = Math.log10(minVal);
                const logMax = Math.log10(maxVal);
                const logV = Math.log10(v);
                const t = (logV - logMin) / (logMax - logMin || 1);
                const hue = 240 - (t * 180); // Blue to Red
                return `hsl(${hue}, 80%, 50%)`;
            }

            mapLayer = L.layerGroup();

            basins.forEach(b => {
                if (b.mip_total > 0) {
                    L.circleMarker([b.lat, b.lon], {
                        radius: 4,
                        fillColor: getColor(b.mip_total),
                        color: "#000",
                        weight: 0.5,
                        opacity: 1,
                        fillOpacity: 0.7
                    }).bindPopup(`
                        <b>Basin ID:</b> ${b.id}<br>
                        <b>Name:</b> ${b.name}<br>
                        <b>Total MIP:</b> ${b.mip_total.toExponential(2)} items/yr<br>
                        <hr style="margin:5px 0;">
                        <b>Transport:</b> ${b.mip_transport.toExponential(2)}<br>
                        <b>Precipitation:</b> ${b.mip_precipitation.toExponential(2)}<br>
                        <b>Deposition:</b> ${b.mip_deposition.toExponential(2)}<br>
                        <b>Land Dry:</b> ${b.mip_land_dry.toExponential(2)}
                    `).addTo(mapLayer);
                }
            });

            mapLayer.addTo(map);
            updateLegend(minVal, maxVal);
        }

        function updateLegend(min, max) {
            const div = document.getElementById('legendContent');
            let html = `<div style="margin-bottom:5px; font-weight:bold;">MIP Sewage Input</div>`;
            html += `<div style="background: linear-gradient(to right, hsl(240,80%,50%), hsl(120,80%,50%), hsl(0,80%,50%)); height:10px; width:100%; margin-bottom:5px;"></div>`;
            html += `<div style="display:flex; justify-content:space-between; font-size:0.8em;">
                <span>${min.toExponential(1)}</span>
                <span>${max.toExponential(1)}</span>
            </div>`;
            html += `<div style="text-align:center; font-size:0.8em; color:#777;">(items/yr, Log Scale)</div>`;
            div.innerHTML = html;
        }

        function updateStats() {
            if (!window.MIP_DATA_DDM30) return;
            document.getElementById('totalBasins').textContent = window.MIP_DATA_DDM30.total_basins.toLocaleString();
            document.getElementById('totalMIP').textContent = window.MIP_DATA_DDM30.total_mip_items.toExponential(2) + ' items/yr';
        }

        // Initialize
        window.addEventListener('load', () => {
            initMap();
            updateStats();
            updateMap();
        });
    </script>
</body>

</html>